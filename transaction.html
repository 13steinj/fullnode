<!DOCTYPE html><html lang="en"><head><title>transaction</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="transaction"><meta name="groc-project-path" content="lib/transaction.js"><meta name="groc-github-url" content="https://github.com/ryanxcharles/fullnode"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/ryanxcharles/fullnode/blob/master/lib/transaction.js">lib/transaction.js</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> Txin = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./txin'</span>);
<span class="hljs-keyword">var</span> Txout = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./txout'</span>);
<span class="hljs-keyword">var</span> BufferWriter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./bufferwriter'</span>);
<span class="hljs-keyword">var</span> BufferReader = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./bufferreader'</span>);
<span class="hljs-keyword">var</span> Varint = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./varint'</span>);
<span class="hljs-keyword">var</span> Hash = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./hash'</span>);

<span class="hljs-keyword">var</span> Transaction = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Transaction</span><span class="hljs-params">(version, txinsvi, txins, txoutsvi, txouts, nlocktime)</span> {</span>
  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> Transaction))
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Transaction(version, txinsvi, txins, txoutsvi, txouts, nlocktime);
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> version === <span class="hljs-string">'number'</span>) {
    <span class="hljs-keyword">this</span>.initialize();
    <span class="hljs-keyword">this</span>.set({
      version: version,
      txinsvi: txinsvi,
      txins: txins,
      txoutsvi: txoutsvi,
      txouts: txouts,
      nlocktime: nlocktime
    });
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Buffer.isBuffer(version)) {
    <span class="hljs-comment">//not necessary to initialize, since everything should be overwritten</span>
    <span class="hljs-keyword">var</span> txbuf = version;
    <span class="hljs-keyword">this</span>.fromBuffer(txbuf);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (version) {
    <span class="hljs-keyword">this</span>.initialize();
    <span class="hljs-keyword">var</span> obj = version;
    <span class="hljs-keyword">this</span>.set(obj);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>.initialize();
  }
};

Transaction.prototype.initialize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">this</span>.version = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">this</span>.txinsvi = Varint(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">this</span>.txins = [];
  <span class="hljs-keyword">this</span>.txoutsvi = Varint(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">this</span>.txouts = [];
  <span class="hljs-keyword">this</span>.nlocktime = <span class="hljs-number">0xffffffff</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

Transaction.prototype.set = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> {</span>
  <span class="hljs-keyword">this</span>.version = <span class="hljs-keyword">typeof</span> obj.version !== <span class="hljs-string">'undefined'</span> ? obj.version : <span class="hljs-keyword">this</span>.version;
  <span class="hljs-keyword">this</span>.txinsvi = obj.txinsvi || <span class="hljs-keyword">this</span>.txinsvi;
  <span class="hljs-keyword">this</span>.txins = obj.txins || <span class="hljs-keyword">this</span>.txins;
  <span class="hljs-keyword">this</span>.txoutsvi = obj.txoutsvi || <span class="hljs-keyword">this</span>.txoutsvi;
  <span class="hljs-keyword">this</span>.txouts = obj.txouts || <span class="hljs-keyword">this</span>.txouts;
  <span class="hljs-keyword">this</span>.nlocktime = <span class="hljs-keyword">typeof</span> obj.nlocktime !== <span class="hljs-string">'undefined'</span> ? obj.nlocktime : <span class="hljs-keyword">this</span>.nlocktime;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

Transaction.prototype.fromJSON = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(json)</span> {</span>
  <span class="hljs-keyword">var</span> txins = [];
  json.txins.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(txin)</span> {</span>
    txins.push(Txin().fromJSON(txin));
  });
  <span class="hljs-keyword">var</span> txouts = [];
  json.txouts.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(txout)</span> {</span>
    txouts.push(Txout().fromJSON(txout));
  });
  <span class="hljs-keyword">this</span>.set({
    version: json.version,
    txinsvi: Varint().fromJSON(json.txinsvi),
    txins: txins,
    txoutsvi: Varint().fromJSON(json.txoutsvi),
    txouts: txouts,
    nlocktime: json.nlocktime
  });
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

Transaction.prototype.toJSON = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> txins = [];
  <span class="hljs-keyword">this</span>.txins.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(txin)</span> {</span>
    txins.push(txin.toJSON());
  });
  <span class="hljs-keyword">var</span> txouts = [];
  <span class="hljs-keyword">this</span>.txouts.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(txout)</span> {</span>
    txouts.push(txout.toJSON());
  });
  <span class="hljs-keyword">return</span> {
    version: <span class="hljs-keyword">this</span>.version,
    txinsvi: <span class="hljs-keyword">this</span>.txinsvi.toJSON(),
    txins: txins,
    txoutsvi: <span class="hljs-keyword">this</span>.txoutsvi.toJSON(),
    txouts: txouts,
    nlocktime: <span class="hljs-keyword">this</span>.nlocktime
  };
};

Transaction.prototype.fromBuffer = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(buf)</span> {</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.fromBufferReader(BufferReader(buf));
};

Transaction.prototype.fromBufferReader = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(br)</span> {</span>
  <span class="hljs-keyword">this</span>.version = br.readUInt32LE();
  <span class="hljs-keyword">this</span>.txinsvi = Varint(br.readVarintBuf());
  <span class="hljs-keyword">var</span> txinsnum = <span class="hljs-keyword">this</span>.txinsvi.toNumber();
  <span class="hljs-keyword">this</span>.txins = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; txinsnum; i++) {
    <span class="hljs-keyword">this</span>.txins.push(Txin().fromBufferReader(br));
  }
  <span class="hljs-keyword">this</span>.txoutsvi = Varint(br.readVarintBuf());
  <span class="hljs-keyword">var</span> txoutsnum = <span class="hljs-keyword">this</span>.txoutsvi.toNumber();
  <span class="hljs-keyword">this</span>.txouts = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; txoutsnum; i++) {
    <span class="hljs-keyword">this</span>.txouts.push(Txout().fromBufferReader(br));
  }
  <span class="hljs-keyword">this</span>.nlocktime = br.readUInt32LE();
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

Transaction.prototype.toBuffer = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.toBufferWriter().concat();
};

Transaction.prototype.toBufferWriter = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(bw)</span> {</span>
  <span class="hljs-keyword">if</span> (!bw)
    bw = <span class="hljs-keyword">new</span> BufferWriter();
  bw.writeUInt32LE(<span class="hljs-keyword">this</span>.version);
  bw.write(<span class="hljs-keyword">this</span>.txinsvi.buf);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.txins.length; i++) {
    <span class="hljs-keyword">this</span>.txins[i].toBufferWriter(bw);
  }
  bw.write(<span class="hljs-keyword">this</span>.txoutsvi.buf)
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.txouts.length; i++) {
    <span class="hljs-keyword">this</span>.txouts[i].toBufferWriter(bw);
  }
  bw.writeUInt32LE(<span class="hljs-keyword">this</span>.nlocktime);
  <span class="hljs-keyword">return</span> bw;
};

Transaction.prototype.hash = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">return</span> Hash.sha256sha256(<span class="hljs-keyword">this</span>.toBuffer());
};

Transaction.prototype.id = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">return</span> BufferReader(<span class="hljs-keyword">this</span>.hash()).reverse().read();
};

Transaction.prototype.addTxin = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(txin)</span> {</span>
  <span class="hljs-keyword">this</span>.txins.push(txin);
  <span class="hljs-keyword">this</span>.txinsvi = Varint(<span class="hljs-keyword">this</span>.txinsvi.toNumber() + <span class="hljs-number">1</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

Transaction.prototype.addTxout = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(txout)</span> {</span>
  <span class="hljs-keyword">this</span>.txouts.push(txout);
  <span class="hljs-keyword">this</span>.txoutsvi = Varint(<span class="hljs-keyword">this</span>.txoutsvi.toNumber() + <span class="hljs-number">1</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

module.exports = Transaction;</div></div></div></div></body></html>